<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <meta name="robots" content="noindex, nofollow">
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">

    <title>Suivi S√©ance Musculation - All-in-One</title>
    
    <style>
        /* --- All CSS is now inline in this style tag --- */
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        h2 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 2rem;
            font-size: 2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .controls label {
            font-weight: 600;
            color: #4a5568;
        }
        select, input[type="number"], input[type="text"] {
            padding: 0.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            background: white;
            margin-bottom: 2rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        th, td {
            padding: 1rem 0.5rem;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.3s ease;
        }
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .exercise-row:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        .exercise-row:nth-child(even) {
            background: rgba(248, 250, 252, 0.8);
        }
        .fixed-col {
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            position: sticky;
            left: 0;
            background: inherit;
            min-width: 200px;
            padding-left: 1rem;
        }
        .serie-input {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            align-items: center;
        }
        .serie-input input {
            width: 60px;
            padding: 0.4rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .serie-input input.completed {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border-color: #38a169;
        }
        .stats-cell {
            font-weight: 600;
            color: #4a5568;
        }
        .tonnage-high {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border-radius: 6px;
            padding: 0.5rem;
        }
        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .timer-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        .timer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .timer-display {
            font-weight: bold;
            font-size: 1.1rem;
            color: #4a5568;
            min-width: 60px;
        }
        .timer-active {
            color: #48bb78;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .summary-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .summary-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .summary-card h3 {
            margin: 0 0 0.5rem 0;
            color: #4a5568;
            font-size: 1.1rem;
        }
        .summary-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 150px;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #ed8936, #dd6b20); color: white; }
        .btn-danger { background: linear-gradient(135deg, #f56565, #e53e3e); color: white; }
        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); color: white; }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .notification.error { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .notification.info { background: linear-gradient(135deg, #4299e1, #3182ce); }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: 1rem;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #e2e8f0;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 30px;
            text-align: center;
        }
        #historyList {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .history-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .history-item-info {
            font-weight: 600;
            color: #4a5568;
        }
        .history-item-info span {
            font-weight: bold;
            color: #667eea;
        }
        .history-item-actions button {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        .history-details {
            display: none; /* Hidden by default */
            width: 100%;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        .history-details.visible {
            display: block; /* Shown on toggle */
        }
        .history-details table {
            min-width: 0;
            font-size: 0.9rem;
        }
        .history-details th {
            background: #e2e8f0;
            color: #4a5568;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .main-container { padding: 1rem; margin: 0.5rem; }
            h2 { font-size: 1.5rem; }
            .controls { flex-direction: column; align-items: stretch; }
            th, td { padding: 0.5rem 0.25rem; font-size: 0.85rem; }
            .fixed-col { min-width: 150px; font-size: 0.8rem; }
            .btn { min-width: 120px; padding: 0.6rem 1rem; font-size: 0.9rem; }
            .summary-section { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h2>üí™ Suivi S√©ance Musculation</h2>
        
        <div class="controls">
          <label for="sessionSelect"><strong>üèãÔ∏è Choisir une s√©ance :</strong></label>
          <select id="sessionSelect">
            <option value="0">PUSH (Poitrine/√âpaules/Triceps)</option>
            <option value="1">PULL (Dos/Biceps)</option>
            <option value="2">LEG (Jambes)</option>
            <option value="3">√âpaules/Bras</option>
            <option value="4">Dos/Pec</option>
          </select>
          
          <div class="custom-exercise">
            <input type="text" id="customExercise" placeholder="Nom de l'exercice">
            <input type="text" id="customRest" placeholder="Repos (ex: 2 min)" value="1 min">
            <button class="btn btn-success" id="addExerciseBtn">+ Ajouter</button>
          </div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        
        <div class="table-container">
          <table id="workoutTable">
            <thead>
              <tr>
                <th>Exercice</th>
                <th colspan="5">S√©ries (Reps / Poids kg)</th>
                <th>Tonnage</th>
                <th>Total Reps</th>
                <th>Moy. kg/rep</th>
                <th>Repos</th>
                <th>Minuteur</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        
        <div class="summary-section">
            <div class="summary-card">
                <h3>üèãÔ∏è Tonnage Total</h3>
                <div class="value" id="totalTonnage">0</div>
                <div class="unit">kg</div>
            </div>
            <div class="summary-card">
                <h3>üìä Semaine Pr√©c√©dente</h3>
                <input type="number" id="previousWeek" style="font-size: 1.5rem; text-align: center; border: none; background: transparent; font-weight: bold; color: #667eea; width: 100px;">
                <div class="unit">kg</div>
            </div>
            <div class="summary-card">
                <h3>üìà Progression</h3>
                <div class="value" id="delta">0</div>
                <div class="unit">kg</div>
            </div>
            <div class="summary-card">
                <h3>‚è±Ô∏è Temps Total</h3>
                <div class="value" id="totalTime">0</div>
                <div class="unit">min</div>
            </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-danger" id="finishSessionBtn">‚úîÔ∏è Terminer & Sauvegarder</button>
          <button class="btn btn-primary" id="viewHistoryBtn">üìñ Voir l'historique</button>
          <button class="btn btn-secondary" id="exportCsvBtn">üìä Exporter CSV</button>
          <button class="btn btn-success" id="importFileBtn">üì• Importer JSON</button>
          <input type="file" id="importFile" accept=".json" style="display: none">
        </div>
    </div>
    
    <div id="notification-container"></div>
    
    <div id="historyModal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
          <button id="closeHistoryModal" class="modal-close-btn">&times;</button>
          <h2>Historique des S√©ances</h2>
          <div id="historyList">
              </div>
      </div>
    </div>

    <script>
        // --- All JavaScript is now inline in this script tag ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- STATE MANAGEMENT ---
            let sessions = [
                [ // PUSH
                    { name: "DC barre lourd", rest: "2 min" },
                    { name: "DC barre l√©ger", rest: "2 min" },
                    { name: "Inclin√© halt√®res", rest: "1 min" },
                    { name: "√âcart√© vis √† vis", rest: "1 min" },
                    { name: "Dips machine", rest: "1 min" },
                    { name: "√âl√©vation lat√©rale machine debout", rest: "1 min" },
                    { name: "Extension triceps poulie", rest: "1 min" }
                ],
                [ // PULL
                    { name: "Traction", rest: "2 min" },
                    { name: "Pull poulie", rest: "1 min" },
                    { name: "Tirage uni poulie haute sur banc", rest: "1 min" },
                    { name: "Rowing T bar", rest: "1 min" },
                    { name: "Machine Row", rest: "1 min" },
                    { name: "Machine Row uni", rest: "1 min" },
                    { name: "Face pull", rest: "1 min" },
                    { name: "Oiseaux machine", rest: "1 min" },
                    { name: "Curl marteau simultan√©", rest: "30s" },
                    { name: "Bayesian curl", rest: "30s" }
                ],
                [ // LEG
                    { name: "Leg extension drop", rest: "1 min" },
                    { name: "Presse horizontal", rest: "2 min" },
                    { name: "Squat guid√© l√©ger", rest: "1 min" },
                    { name: "Fente march√©", rest: "2 min" },
                    { name: "Leg Curl assis", rest: "1 min" },
                    { name: "SDT jambes tendues smith", rest: "1 min" }
                ],
                [ // √âpaules/Bras
                    { name: "Militaire halt√®res pyramide montante", rest: "3 min" },
                    { name: "√âl√©vation lat√©rale", rest: "1 min" },
                    { name: "√âl√©vation lat√©rale supination", rest: "1 min" },
                    { name: "Face pull", rest: "1 min" },
                    { name: "Extension triceps", rest: "1 min" },
                    { name: "Curl poulie basse", rest: "0" },
                    { name: "Magic triceps", rest: "0" },
                    { name: "Curl pupitre", rest: "0" },
                    { name: "Dips", rest: "0" },
                    { name: "Curl halt√®res inclin√©", rest: "0" },
                    { name: "Cross Cable Triceps", rest: "0" },
                    { name: "Curl concentr√© halt√®re", rest: "0" }
                ],
                [ // Dos/Pec
                    { name: "Tirage horizontal", rest: "1 min" },
                    { name: "Rowing barre buste pench√© pronation", rest: "1 min" },
                    { name: "Tirage poulie basse avec corde", rest: "1 min" },
                    { name: "Inclin√© guid√©", rest: "2 min" },
                    { name: "√âcart√© couch√©", rest: "1 min" },
                    { name: "Vis √† vis sur banc inclin√©", rest: "1 min" },
                    { name: "Circuit abdos", rest: "1 min" }
                ]
            ];
            let currentSessionIndex = 0;
            let timers = {};
            let workoutStartTime = null;

            // --- DOM Elements ---
            const sessionSelect = document.getElementById('sessionSelect');
            const tbody = document.getElementById('tbody');
            const totalTonnageEl = document.getElementById('totalTonnage');
            const previousWeekInput = document.getElementById('previousWeek');
            const deltaEl = document.getElementById('delta');
            const totalTimeEl = document.getElementById('totalTime');
            const progressFill = document.getElementById('progressFill');

            // --- CORE FUNCTIONS ---
            function createTable() {
                tbody.innerHTML = "";
                const exercises = sessions[currentSessionIndex];
                
                exercises.forEach((ex, idx) => {
                    const tr = document.createElement("tr");
                    tr.classList.add("exercise-row");
                    tr.dataset.exerciseIndex = idx;

                    let seriesHtml = "";
                    for(let i = 0; i < 5; i++) {
                        seriesHtml += `
                            <td>
                                <div class="serie-input">
                                    <input type="number" min="0" data-ex="${idx}" data-serie="${i}" class="reps" placeholder="Reps">
                                    <input type="number" min="0" step="0.5" data-ex="${idx}" data-serie="${i}" class="weight" placeholder="kg">
                                </div>
                            </td>`;
                    }
                    
                    tr.innerHTML = `
                        <td class="fixed-col">${ex.name}</td>
                        ${seriesHtml}
                        <td class="stats-cell" id="tonnage-${idx}">0</td>
                        <td class="stats-cell" id="totalReps-${idx}">0</td>
                        <td class="stats-cell" id="avg-${idx}">0</td>
                        <td><strong>${ex.rest}</strong></td>
                        <td>
                            <div class="timer-container">
                                <div class="timer-display" id="timer-${idx}">0:00</div>
                                <button class="timer-btn" data-timer-action="start">Start</button>
                                <button class="timer-btn" data-timer-action="stop" style="display: none;">Stop</button>
                                <button class="timer-btn" data-timer-action="reset">Reset</button>
                            </div>
                        </td>
                        <td>
                            <button class="timer-btn" data-action="remove" style="background: #f56565;">üóëÔ∏è</button>
                        </td>`;
                    
                    tbody.appendChild(tr);
                });
                
                loadCurrentState();
                updateAllTotals();
            }

            function updateAllTotals() {
                let totalTonnage = 0;
                const exercises = sessions[currentSessionIndex];
                
                exercises.forEach((_, idx) => {
                    let tonnage = 0;
                    let totalReps = 0;
                    
                    for(let i = 0; i < 5; i++) {
                        const repsInput = document.querySelector(`.reps[data-ex='${idx}'][data-serie='${i}']`);
                        const weightInput = document.querySelector(`.weight[data-ex='${idx}'][data-serie='${i}']`);
                        const reps = +repsInput?.value || 0;
                        const weight = +weightInput?.value || 0;
                        
                        if (reps > 0 && weight > 0) {
                            tonnage += reps * weight;
                            totalReps += reps;
                            repsInput.classList.add('completed');
                            weightInput.classList.add('completed');
                        } else {
                            repsInput?.classList.remove('completed');
                            weightInput?.classList.remove('completed');
                        }
                    }
                    
                    const tonnageEl = document.getElementById(`tonnage-${idx}`);
                    if (tonnageEl) {
                        tonnageEl.textContent = tonnage;
                        tonnageEl.classList.toggle('tonnage-high', tonnage > 0);
                        document.getElementById(`totalReps-${idx}`).textContent = totalReps;
                        document.getElementById(`avg-${idx}`).textContent = totalReps ? (tonnage / totalReps).toFixed(2) : 0;
                    }
                    totalTonnage += tonnage;
                });
                
                totalTonnageEl.textContent = totalTonnage;
                
                const previous = +previousWeekInput.value || 0;
                const delta = totalTonnage - previous;
                deltaEl.textContent = delta > 0 ? `+${delta}` : delta;
                deltaEl.style.color = delta > 0 ? '#48bb78' : delta < 0 ? '#f56565' : '#4a5568';
                
                updateProgress();
                saveCurrentState();
            }

            function updateProgress() {
                const allInputs = document.querySelectorAll('.reps, .weight');
                const completedInputs = document.querySelectorAll('.completed');
                const progress = allInputs.length > 0 ? (completedInputs.length / allInputs.length) * 100 : 0;
                progressFill.style.width = `${progress}%`;
            }

            // --- DATA PERSISTENCE (LocalStorage) ---
            function saveCurrentState() {
                const data = {
                    reps: [...document.querySelectorAll(".reps")].map(i => i.value),
                    weight: [...document.querySelectorAll(".weight")].map(i => i.value),
                    previousWeek: previousWeekInput.value,
                    sessionIndex: currentSessionIndex,
                    customSessions: sessions,
                    workoutStartTime: workoutStartTime
                };
                localStorage.setItem('inProgressWorkout', JSON.stringify(data));
            }

            function loadCurrentState() {
                const data = JSON.parse(localStorage.getItem('inProgressWorkout'));
                if (!data) return;

                if (data.customSessions) sessions = data.customSessions;
                
                if (data.sessionIndex === currentSessionIndex) {
                    document.querySelectorAll(".reps").forEach((input, idx) => {
                        if (data.reps[idx]) input.value = data.reps[idx];
                    });
                    document.querySelectorAll(".weight").forEach((input, idx) => {
                        if (data.weight[idx]) input.value = data.weight[idx];
                    });
                    previousWeekInput.value = data.previousWeek || "";
                }
                
                if (data.workoutStartTime && !workoutStartTime) {
                    workoutStartTime = data.workoutStartTime;
                    updateTotalTimeDisplay();
                }

                updateAllTotals();
            }
            
            function resetSession() {
                Object.values(timers).forEach(timer => clearInterval(timer.interval));
                timers = {};
                workoutStartTime = null;
                localStorage.removeItem('inProgressWorkout');
                createTable();
                totalTimeEl.textContent = 0;
                showNotification("S√©ance r√©initialis√©e", "info");
            }

            // --- WORKOUT HISTORY SYSTEM ---
            function getHistory() {
                return JSON.parse(localStorage.getItem('workoutHistory')) || [];
            }

            function finishAndSaveSession() {
                const totalTonnage = +totalTonnageEl.textContent;
                if (totalTonnage === 0) {
                    if (confirm("La s√©ance est vide. Voulez-vous vraiment la r√©initialiser sans sauvegarder?")) {
                        resetSession();
                    }
                    return;
                }

                const workoutData = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    sessionName: sessionSelect.selectedOptions[0].text,
                    totalTonnage: totalTonnage,
                    workoutDuration: workoutStartTime ? Math.floor((Date.now() - workoutStartTime) / 1000 / 60) : 0,
                    exercises: sessions[currentSessionIndex].map((ex, idx) => {
                        const series = [];
                        for(let i = 0; i < 5; i++) {
                            const reps = +document.querySelector(`.reps[data-ex='${idx}'][data-serie='${i}']`).value || 0;
                            const weight = +document.querySelector(`.weight[data-ex='${idx}'][data-serie='${i}']`).value || 0;
                            if (reps > 0 || weight > 0) {
                                series.push({ reps, weight, tonnage: reps * weight });
                            }
                        }
                        return { name: ex.name, series };
                    }).filter(ex => ex.series.length > 0)
                };

                const history = getHistory();
                history.push(workoutData);
                localStorage.setItem('workoutHistory', JSON.stringify(history));

                showNotification("S√©ance sauvegard√©e dans l'historique!", "success");
                resetSession();
            }

            function displayHistory() {
                const history = getHistory().sort((a, b) => b.id - a.id);
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';

                if (history.length === 0) {
                    historyList.innerHTML = '<p>Aucune s√©ance dans l\'historique.</p>';
                    return;
                }

                history.forEach(session => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="history-item-info">
                            ${new Date(session.date).toLocaleDateString('fr-FR')} - 
                            <strong>${session.sessionName}</strong> - 
                            Tonnage: <span>${session.totalTonnage} kg</span>
                        </div>
                        <div class="history-item-actions">
                            <button class="btn btn-primary" data-history-action="details" data-history-id="${session.id}">D√©tails</button>
                            <button class="btn btn-danger" data-history-action="delete" data-history-id="${session.id}">Suppr.</button>
                        </div>
                        <div class="history-details" id="details-${session.id}">
                            <table>
                                <thead><tr><th>Exercice</th><th>S√©rie</th><th>Reps</th><th>Poids</th></tr></thead>
                                <tbody>
                                    ${session.exercises.map(ex => 
                                        ex.series.map((s, i) => `
                                            <tr>
                                                <td>${ex.name}</td>
                                                <td>${i + 1}</td>
                                                <td>${s.reps}</td>
                                                <td>${s.weight} kg</td>
                                            </tr>
                                        `).join('')
                                    ).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    historyList.appendChild(item);
                });
            }

            function deleteFromHistory(id) {
                if (!confirm("√ätes-vous s√ªr de vouloir supprimer cette s√©ance de l'historique?")) return;
                
                let history = getHistory();
                history = history.filter(session => session.id !== id);
                localStorage.setItem('workoutHistory', JSON.stringify(history));
                displayHistory();
                showNotification("S√©ance supprim√©e de l'historique.", "info");
            }


            // --- UTILITY & UI FUNCTIONS ---
            function selectSession() {
                currentSessionIndex = parseInt(sessionSelect.value);
                resetSession();
            }

            function addCustomExercise() {
                const exerciseName = document.getElementById("customExercise").value.trim();
                const restTime = document.getElementById("customRest").value.trim();
                
                if (!exerciseName) {
                    showNotification("Veuillez entrer un nom d'exercice", "error");
                    return;
                }
                
                sessions[currentSessionIndex].push({ name: exerciseName, rest: restTime || "1 min" });
                createTable();
                saveCurrentState();
                showNotification("Exercice ajout√© avec succ√®s!", "success");
            }

            function removeExercise(idx) {
                if (sessions[currentSessionIndex].length <= 1) {
                    showNotification("Impossible de supprimer le dernier exercice", "error");
                    return;
                }
                sessions[currentSessionIndex].splice(idx, 1);
                createTable();
                showNotification("Exercice supprim√©", "info");
            }

            function startTimer(idx) {
                if (timers[idx]) clearInterval(timers[idx].interval);
                
                if (!workoutStartTime) {
                    workoutStartTime = Date.now();
                    updateTotalTimeDisplay();
                }
                
                timers[idx] = {
                    seconds: 0,
                    interval: setInterval(() => {
                        timers[idx].seconds++;
                        updateTimerDisplay(idx);
                    }, 1000)
                };
                
                const row = document.querySelector(`[data-exercise-index='${idx}']`);
                row.querySelector('[data-timer-action="start"]').style.display = 'none';
                row.querySelector('[data-timer-action="stop"]').style.display = 'inline-block';
                row.querySelector('.timer-display').classList.add('timer-active');
            }

            function stopTimer(idx) {
                if (timers[idx]) {
                    clearInterval(timers[idx].interval);
                    delete timers[idx];
                }
                const row = document.querySelector(`[data-exercise-index='${idx}']`);
                row.querySelector('[data-timer-action="start"]').style.display = 'inline-block';
                row.querySelector('[data-timer-action="stop"]').style.display = 'none';
                row.querySelector('.timer-display').classList.remove('timer-active');
            }

            function resetTimer(idx) {
                stopTimer(idx);
                document.getElementById(`timer-${idx}`).textContent = '0:00';
            }

            function updateTimerDisplay(idx) {
                const timer = timers[idx];
                if (timer) {
                    const minutes = Math.floor(timer.seconds / 60);
                    const seconds = timer.seconds % 60;
                    document.getElementById(`timer-${idx}`).textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }
            
            let totalTimeInterval;
            function updateTotalTimeDisplay() {
                if(totalTimeInterval) clearInterval(totalTimeInterval);

                function update() {
                    if (workoutStartTime) {
                        const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000 / 60);
                        totalTimeEl.textContent = elapsed;
                    }
                }
                update();
                totalTimeInterval = setInterval(update, 60000);
            }

            function showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                container.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => container.removeChild(notification), 300);
                }, 3000);
            }
            
            // --- EVENT LISTENERS ---
            tbody.addEventListener('change', (e) => {
                if (e.target.classList.contains('reps') || e.target.classList.contains('weight')) {
                    updateAllTotals();
                }
            });

            tbody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const action = target.dataset.action || target.dataset.timerAction;
                const row = target.closest('.exercise-row');
                const idx = parseInt(row.dataset.exerciseIndex, 10);

                switch(action) {
                    case 'remove': removeExercise(idx); break;
                    case 'start': startTimer(idx); break;
                    case 'stop': stopTimer(idx); break;
                    case 'reset': resetTimer(idx); break;
                }
            });

            sessionSelect.addEventListener('change', selectSession);
            document.getElementById('addExerciseBtn').addEventListener('click', addCustomExercise);
            previousWeekInput.addEventListener('change', updateAllTotals);
            document.getElementById('finishSessionBtn').addEventListener('click', finishAndSaveSession);
            document.getElementById('viewHistoryBtn').addEventListener('click', () => {
                displayHistory();
                document.getElementById('historyModal').style.display = 'flex';
            });
            document.getElementById('closeHistoryModal').addEventListener('click', () => {
                document.getElementById('historyModal').style.display = 'none';
            });
            
            document.getElementById('historyList').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const action = target.dataset.historyAction;
                const id = parseInt(target.dataset.historyId, 10);
                if (action === 'delete') {
                    deleteFromHistory(id);
                } else if (action === 'details') {
                    document.getElementById(`details-${id}`).classList.toggle('visible');
                }
            });
            
            function init() {
                const savedSessionIndex = JSON.parse(localStorage.getItem('inProgressWorkout'))?.sessionIndex;
                if (savedSessionIndex !== undefined) {
                    currentSessionIndex = savedSessionIndex;
                    sessionSelect.value = savedSessionIndex;
                }
                createTable();
            }

            init();
        });
    </script>
</body>
</html>